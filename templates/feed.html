{% extends 'base.html' %}
{% from '_macros.html' import render_comment_thread %}

{% block title %}{{ _('Feed') }} - PiVerse{% endblock %}

{% block head_extra %}
{{ super() }}
<style>
/* Estilos existentes y el nuevo para quote-content-box y post-section-link */
.mention-suggestions-list { position: absolute; background-color: white; border: 1px solid #ddd; border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.15); z-index: 1000; width: auto; min-width: 200px; max-height: 200px; overflow-y: auto; margin-top: 2px; }
.mention-suggestions-list ul { list-style: none; padding: 0; margin: 0; }
.mention-suggestions-list li { padding: 8px 12px; cursor: pointer; display: flex; align-items: center; font-size: 0.9rem; }
.mention-suggestions-list li:hover { background-color: #f5f5f5; }
.mention-suggestions-list img { width: 24px; height: 24px; border-radius: 50%; margin-right: 8px; object-fit: cover; }
.mention-suggestions-list .no-photo { width: 24px; height: 24px; border-radius: 50%; margin-right: 8px; background-color: #eee; display: inline-flex; align-items: center; justify-content: center; }
.mention-suggestions-list .no-photo i { font-size: 12px; color: #777; }
.comment-replies { margin-left: 40px; padding-left: 15px; border-left: 2px solid #eee; margin-top: 10px; }
.comment-container { margin-bottom: 15px; }
.reactions-container .reactions-palette { display: none; position: absolute; bottom: 100%; left: 0; margin-bottom: 5px; z-index: 10; white-space: nowrap; border-spacing: 2px; gap: 5px; }
.reaction-icon-btn { font-size: 1.5rem; padding: 0.2rem 0.4rem; text-decoration: none; border: none; background: none; cursor: pointer; }
.reaction-icon-btn:hover { transform: scale(1.2); transition: transform 0.1s ease-in-out; }
.original-post-embed { border: 1px solid #e9ecef; padding: 1rem; border-radius: .25rem; background-color: #f8f9fa; }
.shared-by-line { font-size: 0.9em; color: #6c757d; margin-bottom: 0.5rem; }
.shared-by-line i { font-size: 1.1em; }
.quote-content-box { background-color: #f0f0f0; border-left: 3px solid #0d6efd; padding: 0.75rem 1rem; margin-bottom: 0.75rem; border-radius: .25rem; white-space: pre-wrap; font-style: italic; }
.post-section-link a { font-size: 0.85em; font-weight: 500; }
</style>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8 col-lg-7">
        
        <h2 class="mb-3">{{ _('Feed') }}</h2>

        <ul class="nav nav-tabs mb-4">
          <li class="nav-item">
            <a class="nav-link active" aria-current="page" href="{{ url_for('feed') }}">{{ _('Para ti') }}</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="{{ url_for('contacts_feed') }}">{{ _('Contactos') }}</a>
          </li>
        </ul>

        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <h5 class="card-title">{{ _('Nueva Publicación') }}</h5>
                <form method="post" action="{{ url_for('post') }}" enctype="multipart/form-data">
                    <div class="mb-3 position-relative">
                        <textarea class="form-control mentionable-input" name="content" rows="3" placeholder="{{ _('¿Qué estás pensando, %(username)s?', username=(display_username_session or _('Pionero'))) }}"></textarea>
                        <div class="mention-suggestions-list" style="display: none;"></div>
                    </div>
                    <div class="mb-3">
                        <label for="post_image" class="form-label">{{ _('Añadir imagen (opcional)') }}</label>
                        <input class="form-control" type="file" id="post_image" name="post_image" accept="image/png, image/jpeg, image/gif">
                    </div>
                    {% if sections %}
                    <div class="mb-3">
                        <label for="section_id" class="form-label">{{ _('Seleccionar Sección (opcional)') }}</label>
                        <select class="form-select form-select-sm" name="section_id" id="section_id">
                            <option value="">-- {{ _('Ninguna') }} --</option>
                            {% for section in sections %}
                                <option value="{{ section.id }}">{{ section.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    {% endif %}
                    <button type="submit" class="btn btn-primary"><i class="bi bi-send-fill"></i> {{ _('Publicar') }}</button>
                </form>
            </div>
        </div>

        <div id="feed-posts-container">
            {% if posts %}
                {% for item in posts %}
                    {% include '_post_card.html' %}
                {% endfor %}
            {% else %}
                <div class="text-center p-5 card shadow-sm">
                    <p class="lead">{{ _('Aún no hay publicaciones en el feed.') }}</p>
                    <p>{{ _('¡Sigue a otros pioneros o crea tu primera publicación!') }}</p>
                </div>
            {% endif %}
        </div>
        
        <div id="loading-indicator" class="text-center p-4" style="height: 80px;"></div>

    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- LÓGICA DE INTERACCIONES DE PUBLICACIONES (CON DELEGACIÓN DE EVENTOS) ---
    // Usamos 'document' para delegar eventos y asegurarnos de que funcione en todo el contenido,
    // tanto el cargado inicialmente como el dinámico.
    document.addEventListener('click', function(e) {
        // Lógica para la paleta de reacciones
        const reactionTriggerBtn = e.target.closest('.reaction-trigger-btn');
        if (reactionTriggerBtn) {
            const palette = reactionTriggerBtn.nextElementSibling;
            const isVisible = window.getComputedStyle(palette).display !== 'none';
            // Primero, cerramos todas las demás paletas
            document.querySelectorAll('.reactions-palette').forEach(p => {
                if (p !== palette) p.style.display = 'none';
            });
            // Luego, abrimos o cerramos la paleta actual
            palette.style.display = isVisible ? 'none' : 'flex';
            return; // Salimos para no cerrar la paleta inmediatamente
        }

        // Si se hace clic fuera de una paleta o de su botón, se cierran todas
        if (!e.target.closest('.reactions-container')) {
            document.querySelectorAll('.reactions-palette').forEach(p => {
                p.style.display = 'none';
            });
        }
        
        // Lógica para "Responder a comentario"
        if (e.target.matches('.reply-to-comment-btn')) {
            e.preventDefault();
            const button = e.target;
            const commentId = button.dataset.commentId;
            const usernameToReply = button.dataset.usernameToReply || 'Usuario';
            const slugToReply = button.dataset.slugToReply || '';
            const replyFormContainer = document.getElementById(`reply-form-container-${commentId}`);
            if (replyFormContainer) {
                const textarea = replyFormContainer.querySelector('textarea[name="content"]');
                const isHidden = replyFormContainer.style.display === 'none';
                document.querySelectorAll('.reply-form-container').forEach(c => {
                    if (c.id !== replyFormContainer.id) {
                        c.style.display = 'none';
                        c.querySelector('textarea[name="content"]').value = '';
                    }
                });
                if (isHidden) {
                    textarea.placeholder = `{{ _('Respondiendo a') }} @${usernameToReply}...`;
                    textarea.value = `@${slugToReply} `;
                    replyFormContainer.style.display = 'block';
                    textarea.focus();
                } else {
                    replyFormContainer.style.display = 'none';
                }
            }
        }
    });

    // --- LÓGICA FINAL Y ROBUSTA PARA SCROLL INFINITO ---
    const loadingIndicator = document.getElementById('loading-indicator');
    const postsContainer = document.getElementById('feed-posts-container');
    
    if (postsContainer && loadingIndicator) {
        let page = 1;
        let isLoading = false;
        let allPostsLoaded = (postsContainer.children.length < {{ POSTS_PER_PAGE }});

        if (allPostsLoaded && postsContainer.children.length > 0) {
            loadingIndicator.innerHTML = '<p class="text-muted">{{ _("Has llegado al final.") }}</p>';
        } else if (!allPostsLoaded) {
            loadingIndicator.innerHTML = '';
        }

        const loadMorePosts = () => {
            if (isLoading || allPostsLoaded) return;
            isLoading = true;
            loadingIndicator.innerHTML = `<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>`;
            page++;

            fetch(`/api/feed?page=${page}`)
                .then(response => response.text())
                .then(html => {
                    if (html.trim().length > 0) {
                        postsContainer.insertAdjacentHTML('beforeend', html);
                        isLoading = false; 
                        loadingIndicator.innerHTML = ''; 
                    } else {
                        allPostsLoaded = true;
                        if(observer) { observer.unobserve(loadingIndicator); }
                        loadingIndicator.innerHTML = '<p class="text-muted">{{ _("Has llegado al final.") }}</p>';
                    }
                })
                .catch(err => {
                    console.error('Error al cargar más publicaciones:', err);
                    allPostsLoaded = true;
                    if(observer) { observer.unobserve(loadingIndicator); }
                    loadingIndicator.innerHTML = '<p class="text-danger">{{ _("Error al cargar más contenido.") }}</p>';
                    isLoading = false;
                });
        };

        const observer = new IntersectionObserver((entries) => {
            const firstEntry = entries[0];
            if (firstEntry.isIntersecting && !isLoading) {
                loadMorePosts();
            }
        }, { threshold: 0.01 });

        if (!allPostsLoaded) {
            observer.observe(loadingIndicator);
        }
    }
});
</script>
{% endblock %}