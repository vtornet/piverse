{% extends 'base.html' %}
{% from '_macros.html' import render_comment_thread %}

{% block title %}{{ _('Sección:') }} {{ _(section_name) }} - PiVerse{% endblock %}

{% block head_extra %}
{{ super() }}
<style>
.mention-suggestions-list { position: absolute; background-color: white; border: 1px solid #ddd; border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.15); z-index: 1000; width: auto; min-width: 200px; max-height: 200px; overflow-y: auto; margin-top: 2px; }
.mention-suggestions-list ul { list-style: none; padding: 0; margin: 0; }
.mention-suggestions-list li { padding: 8px 12px; cursor: pointer; display: flex; align-items: center; font-size: 0.9rem; }
.mention-suggestions-list li:hover { background-color: #f5f5f5; }
.mention-suggestions-list img { width: 24px; height: 24px; border-radius: 50%; margin-right: 8px; object-fit: cover; }
.mention-suggestions-list .no-photo { width: 24px; height: 24px; border-radius: 50%; margin-right: 8px; background-color: #eee; display: inline-flex; align-items: center; justify-content: center; }
.mention-suggestions-list .no-photo i { font-size: 12px; color: #777; }
.comment-replies { margin-left: 40px; padding-left: 15px; border-left: 2px solid #eee; margin-top: 10px; }
.comment-container { margin-bottom: 15px; }
.reactions-container .reactions-palette { display: none; position: absolute; bottom: 100%; left: 0; margin-bottom: 5px; z-index: 10; white-space: nowrap; border-spacing: 2px; gap: 5px; }
.reaction-icon-btn { font-size: 1.5rem; padding: 0.2rem 0.4rem; text-decoration: none; border: none; background: none; cursor: pointer; }
.reaction-icon-btn:hover { transform: scale(1.2); transition: transform 0.1s ease-in-out; }
.original-post-embed { border: 1px solid #e9ecef; padding: 1rem; border-radius: .25rem; background-color: #f8f9fa; }
.shared-by-line { font-size: 0.9em; color: #6c757d; margin-bottom: 0.5rem; }
.shared-by-line i { font-size: 1.1em; }
.quote-content-box {
    background-color: #f0f0f0;
    border-left: 3px solid #0d6efd;
    padding: 0.75rem 1rem;
    margin-bottom: 0.75rem;
    border-radius: .25rem;
    white-space: pre-wrap;
    font-style: italic;
}
</style>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8 col-lg-7">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h2 class="mb-0">{{ _('Sección:') }} {{ _(section_name) }}</h2>
            <a href="{{ url_for('sections_list') }}" class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-list-ul"></i> {{ _('Ver todas las secciones') }}
            </a>
        </div>
        <hr>

        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <h5 class="card-title">{{ _('Nueva Publicación en esta Sección') }}</h5>
                <form method="post" action="{{ url_for('post') }}" enctype="multipart/form-data">
                    <input type="hidden" name="source_section_slug" value="{{ section_slug }}">
                    <div class="mb-3 position-relative">
                        <textarea class="form-control mentionable-input" name="content" rows="3" placeholder="{{ _('¿Qué estás pensando, %(username)s?', username=(display_username_session or _('Pionero'))) }}"></textarea>
                        <div class="mention-suggestions-list" style="display: none;"></div>
                    </div>
                    <div class="mb-3">
                        <label for="post_image" class="form-label">{{ _('Añadir imagen (opcional)') }}</label>
                        <input class="form-control" type="file" id="post_image" name="post_image" accept="image/png, image/jpeg, image/gif">
                    </div>
                    {% if sections %}
                    <div class="mb-3">
                        <label for="section_id" class="form-label">{{ _('Sección') }}</label>
                        <select class="form-select form-select-sm" name="section_id" id="section_id">
                            {% for section_opt in sections %}
                                <option value="{{ section_opt.id }}" {% if section_opt.slug == section_slug %}selected{% endif %}>
                                    {{ _(section_opt.name) }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    {% endif %}
                    <button type="submit" class="btn btn-primary"><i class="bi bi-send-fill"></i> {{ _('Publicar') }}</button>
                </form>
            </div>
        </div>
        
        <h4 class="mb-3">{{ _('Publicaciones en esta sección') }}</h4>
        
        <button id="new-posts-button" class="btn btn-primary shadow-lg" style="display: none; position: fixed; top: 70px; left: 50%; transform: translateX(-50%); z-index: 1030;">
            <i class="bi bi-arrow-up-circle-fill"></i> <span>{{ _('Ver nuevas publicaciones') }}</span>
        </button>

        <div id="feed-posts-container" data-latest-post-timestamp="{{ posts[0].timestamp.isoformat() if posts and posts[0].timestamp else '' }}">
            {% if posts %}
                {% include '_post_card_list.html' %}
            {% else %}
                <div class="text-center p-5">
                    <i class="bi bi-chat-square-dots-fill" style="font-size: 3rem;"></i>
                    <p class="lead mt-3">{{ _('Aún no hay publicaciones en esta sección.') }}</p>
                    <p>{{ _('¡Sé el primero en publicar algo aquí!') }}</p>
                </div>
            {% endif %}
        </div>
        
        <div id="loading-indicator" class="text-center p-4" style="height: 80px;"></div>
        </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const loadingIndicator = document.getElementById('loading-indicator');
    const postsContainer = document.getElementById('feed-posts-container');
    const newPostsButton = document.getElementById('new-posts-button');
    const currentSectionSlug = "{{ section_slug|e }}"; 

    if (postsContainer) {
        let page = 1;
        let isLoading = false;
        let postsPerPage = 10;
        let allPostsLoaded = postsContainer.querySelectorAll('.card').length < postsPerPage;

        const loadMorePosts = async () => {
            if (isLoading || allPostsLoaded) return;
            isLoading = true;
            if(loadingIndicator) loadingIndicator.innerHTML = `<div class="spinner-border text-primary" role="status"></div>`;

            try {
                const response = await fetch(`/api/feed?page=${page + 1}&section_slug=${currentSectionSlug}`);
                const html = await response.text();

                if (html.trim().length > 0) {
                    postsContainer.insertAdjacentHTML('beforeend', html);
                    page++;
                    isLoading = false;
                    setTimeout(checkAndLoadIfIndicatorVisible, 100); 
                } else {
                    allPostsLoaded = true;
                    if(observer) observer.disconnect();
                    if(loadingIndicator) loadingIndicator.innerHTML = '<p class="text-muted">{{ _("Has llegado al final de la sección.") }}</p>';
                }
            } catch (err) {
                console.error('Error al cargar más en sección:', err);
                isLoading = false;
            }
        };
        
        const checkAndLoadIfIndicatorVisible = () => {
            if (isLoading || allPostsLoaded || !loadingIndicator) return;
            const rect = loadingIndicator.getBoundingClientRect();
            if (rect.top <= window.innerHeight) {
                loadMorePosts();
            }
        };

        let observer;
        if (loadingIndicator) {
             observer = new IntersectionObserver((entries) => {
                if (entries[0].isIntersecting) {
                    loadMorePosts();
                }
            }, { threshold: 0.1 });
            
            if (!allPostsLoaded) {
                observer.observe(loadingIndicator);
                checkAndLoadIfIndicatorVisible();
            } else if (postsContainer.querySelectorAll('.card').length > 0) {
                 loadingIndicator.innerHTML = '<p class="text-muted">{{ _("Has llegado al final de la sección.") }}</p>';
            }
        }

        if (newPostsButton) {
            let latestTimestamp = postsContainer.dataset.latestPostTimestamp;
            const checkForNewPosts = () => {
                if (!latestTimestamp) return;
                fetch(`/api/feed/check_new?timestamp=${latestTimestamp}&section_slug=${currentSectionSlug}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data && data.new_items_count > 0) {
                            newPostsButton.querySelector('span').textContent = ` {{ _('Ver') }} ${data.new_items_count} {{ _('nuevas') }}`;
                            newPostsButton.style.display = 'block';
                        }
                    });
            };

            setInterval(checkForNewPosts, 30000);
            newPostsButton.addEventListener('click', () => window.location.reload());
        }
    }
});
</script>
{% endblock %}