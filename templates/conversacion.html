{% extends 'base.html' %}

{% block title %}{% trans username=(other_user.username if other_user else _('Usuario')) %}Conversación con @{{ username }}{% endtrans %}{% endblock %}

{% block head_extra %}
<style>
    /* Estilos CSS no requieren traducción */
    .chat-container {
        display: flex;
        flex-direction: column;
        height: 75vh;
    }
    .chat-header {
        padding: 0.75rem 1.25rem;
        border-bottom: 1px solid #dee2e6;
        background-color: #f8f9fa;
    }
    .chat-messages {
        flex-grow: 1;
        overflow-y: auto;
        padding: 1rem;
        display: flex;
        flex-direction: column;
    }
    .message-bubble-wrapper {
        display: flex;
        margin-bottom: 0.75rem;
    }
    .message-bubble {
        max-width: 70%;
        padding: 0.5rem 1rem;
        border-radius: 1rem;
        word-wrap: break-word;
    }
    .message-sent {
        background-color: #0d6efd;
        color: white;
        margin-left: auto; /* Alinea a la derecha */
        border-bottom-right-radius: 0.25rem;
    }
    .message-received {
        background-color: #e9ecef;
        color: black;
        margin-right: auto; /* Alinea a la izquierda */
        border-bottom-left-radius: 0.25rem;
    }
    .chat-input-form {
        padding: 1rem;
        border-top: 1px solid #dee2e6;
    }
</style>
{% endblock %}

{% block content %}
<div class="post-container">
    <a href="{{ url_for('mensajes') }}" class="btn btn-outline-secondary btn-sm mb-3"><i class="bi bi-arrow-left"></i> {{ _('Volver a Mensajes') }}</a>

    <div class="card shadow-sm">
        <div class="chat-container">
            <div class="chat-header">
                <h5 class="mb-0">
                    <a href="{{ url_for('ver_perfil', slug_perfil=other_user.slug if other_user else '#') }}" class="text-decoration-none text-dark">
                        {% if other_user and other_user.photo %}
                             <img src="{{ url_for('static', filename='uploads/' + other_user.photo) }}" class="rounded-circle me-2" style="width: 30px; height: 30px; object-fit: cover;" alt="{{ _('Foto de %(username)s', username=(other_user.username if other_user else _('Usuario'))) }}">
                        {% endif %}
                        @{{ other_user.username if other_user else _('Usuario') }}
                    </a>
                </h5>
            </div>

            <div class="chat-messages" id="chat-messages-container">
                {% if messages %}
                    {% for msg in messages %}
                        <div class="message-bubble-wrapper">
                            <div class="message-bubble {% if msg.sender_id == current_user_id %}message-sent{% else %}message-received{% endif %}">
                                {{ msg.body }} {# El cuerpo del mensaje no se traduce aquí, se guarda como está #}
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <p id="no-messages-placeholder" class="text-center text-muted">{{ _('Aún no hay mensajes. ¡Envía el primero!') }}</p>
                {% endif %}
            </div>

            <div class="chat-input-form">
                <form id="send-message-form">
                    <input type="hidden" id="conversation_id_input" name="conversation_id" value="{{ conversation_id }}">
                    <div class="input-group">
                        <input type="text" id="message-body-input" name="body" class="form-control" placeholder="{{ _('Escribe un mensaje...') }}" autocomplete="off" required>
                        <button class="btn btn-primary" type="submit">{{ _('Enviar') }} <i class="bi bi-send"></i></button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // ... (JavaScript existente) ...
    // Los textos dentro del script que se muestran al usuario, como los 'alert',
    // idealmente se deberían pasar desde el backend o manejar con una librería de i18n para JS.
    // Por ahora, los dejaremos como están, pero es un punto de mejora futuro.
    // Ejemplo: alert('{{ _('Hubo un error al enviar tu mensaje. Inténtalo de nuevo.') }}');
    // Esto requeriría que _() esté disponible en el contexto global de JS o que estos textos
    // se definan en data-attributes en el HTML y se lean desde JS.

    const chatMessagesContainer = document.getElementById('chat-messages-container');
    const messageForm = document.getElementById('send-message-form');
    const messageInput = document.getElementById('message-body-input');
    const conversationId = document.getElementById('conversation_id_input').value;
    const currentUserId = {{ current_user_id }}; 

    function scrollToBottom() {
        chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
    }

    function appendMessage(msg) {
        const placeholder = document.getElementById('no-messages-placeholder');
        if (placeholder) {
            placeholder.remove();
        }

        const bubbleWrapper = document.createElement('div');
        bubbleWrapper.className = 'message-bubble-wrapper';

        const bubble = document.createElement('div');
        bubble.className = 'message-bubble';
        bubble.textContent = msg.body; 

        if (msg.sender_id === currentUserId) {
            bubble.classList.add('message-sent');
        } else {
            bubble.classList.add('message-received');
        }

        bubbleWrapper.appendChild(bubble);
        chatMessagesContainer.appendChild(bubbleWrapper);
        scrollToBottom();
    }

    scrollToBottom();

    messageForm.addEventListener('submit', function(e) {
        e.preventDefault(); 

        const messageBody = messageInput.value.trim();
        if (messageBody === '') {
            return; 
        }

        fetch("{{ url_for('api_enviar_mensaje') }}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                conversation_id: conversationId,
                body: messageBody
            }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                appendMessage(data.message);
                messageInput.value = '';
                messageInput.focus();
            } else {
                console.error('Error al enviar el mensaje:', data.error);
                // Para traducir este alert, necesitaríamos una estrategia para JS i18n.
                alert('{{ _('Hubo un error al enviar tu mensaje. Inténtalo de nuevo.') }}');
            }
        })
        .catch(error => {
            console.error('Error de red:', error);
            alert('{{ _('Hubo un error de red. Por favor, revisa tu conexión.') }}');
        });
    });
});
</script>
{% endblock %}