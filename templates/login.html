{% extends 'base.html' %}

{% block title %}{{ _('Iniciar Sesión') }} - PiVerse{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-6 col-lg-5">
        <div class="card shadow-sm">
            <div class="card-body p-4 p-md-5">
                <div class="text-center mb-4">
                    <img src="{{ url_for('static', filename='images/piverse.png') }}" alt="Logo de PiVerse" style="max-height: 80px;">
                    <h3 class="mt-3">{{ _('Accede a PiVerse') }}</h3>
                    <p class="text-muted">{{ _('Usa tu cuenta de Pi Network para continuar.') }}</p>
                </div>

                {# --- BOTÓN DE LOGIN CON PI (TEXTO CORREGIDO) --- #}
                <div class="d-grid">
                    <button id="pi-auth-button" class="btn btn-lg btn-warning">
                        <i class="bi bi-shield-check me-2"></i>
                        {{ _('Acceder con Pi Network') }}
                    </button>
                </div>
                
                <div id="login-feedback" class="mt-3 text-center"></div>

                {# --- BLOQUE DE LOGIN PARA DESARROLLO LOCAL --- #}
                {% if is_debug_mode %}
                <div class="mt-4 border-top pt-3">
                    <p class="text-muted small mb-1"><strong>{{ _('Solo para desarrollo:') }}</strong></p>
                    <a href="{{ url_for('dev_login', username='tester') }}" class="btn btn-sm btn-outline-secondary">{{ _('Entrar como "tester" (Admin)') }}</a>
                </div>
                {% endif %}

            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const authButton = document.getElementById('pi-auth-button');
    const feedbackDiv = document.getElementById('login-feedback');

    // 1. Inicializar el SDK de Pi con lógica para producción/desarrollo
    // Detecta si la app está en el dominio de producción para desactivar el sandbox.
    const isProduction = window.location.hostname === 'www.piverse.app';
    Pi.init({ version: "2.0", sandbox: !isProduction });

    authButton.addEventListener('click', function() {
        feedbackDiv.innerHTML = `<div class="spinner-border spinner-border-sm" role="status"></div><span class="ms-2">{{ _('Esperando autorización de Pi...') }}</span>`;
        authButton.disabled = true;

        const scopes = ['username']; // 'payments' se puede añadir después cuando se implemente.

        // 2. Llamada al SDK con la sintaxis moderna de Promesas (.then/.catch)
        Pi.authenticate(scopes)
            .then(function(authResult) {
                feedbackDiv.innerHTML = `<div class="spinner-border spinner-border-sm" role="status"></div><span class="ms-2">{{ _('Verificando con el servidor...') }}</span>`;
                
                return fetch("{{ url_for('pi_auth_complete') }}", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(authResult)
                });
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    feedbackDiv.innerHTML = `<div class="alert alert-success p-2 mt-3">{{ _('¡Éxito! Redirigiendo...') }}</div>`;
                    window.location.href = data.redirect_url;
                } else {
                    feedbackDiv.innerHTML = `<div class="alert alert-danger p-2 mt-3">${data.error}</div>`;
                    authButton.disabled = false;
                }
            })
            .catch(error => {
                // Este bloque captura tanto errores de la autenticación de Pi como errores de red.
                console.error('Fallo en el proceso de autenticación:', error);
                
                // Si el error es de la autenticación de Pi, tendrá una propiedad 'type'
                if (error && error.type === 'Authentication_Failed') {
                    feedbackDiv.innerHTML = `<div class="alert alert-warning p-2 mt-3">{{ _('La autorización con Pi fue cancelada o falló.') }}</div>`;
                } else {
                    feedbackDiv.innerHTML = `<div class="alert alert-danger p-2 mt-3">{{ _('Error de conexión con el servidor.') }}</div>`;
                }
                authButton.disabled = false;
            });
    });
});
</script>
{% endblock %}