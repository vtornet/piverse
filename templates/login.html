{% extends 'base.html' %}

{% block title %}{{ _('Iniciar Sesión') }} - PiVerse{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-6 col-lg-5">
        <div class="card shadow-sm">
            <div class="card-body p-4 p-md-5">
                <div class="text-center mb-4">
                    <img src="{{ url_for('static', filename='images/piverse.png') }}" alt="Logo de PiVerse" style="max-height: 80px;">
                    <h3 class="mt-3">{{ _('Accede a PiVerse') }}</h3>
                    <p class="text-muted">{{ _('Usa tu cuenta de Pi Network para continuar.') }}</p>
                </div>

                {# --- BOTÓN DE LOGIN CON PI --- #}
                <div class="d-grid">
                    <button id="pi-login-button" class="btn btn-lg btn-primary" style="background-color: #593A88; border-color: #593A88;">
                        <i class="bi bi-box-arrow-in-right me-2"></i> {{ _('Iniciar Sesión con Pi') }}
                    </button>
                </div>
                
                <div id="login-feedback" class="mt-3 text-center"></div>

            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const loginButton = document.getElementById('pi-login-button');
    const feedbackDiv = document.getElementById('login-feedback');

    // 1. Inicializar el SDK de Pi
    Pi.init({ version: "2.0", sandbox: true });

    // 2. Lógica para el botón de login
    loginButton.addEventListener('click', function() {
        feedbackDiv.innerHTML = `<div class="spinner-border spinner-border-sm" role="status"></div><span class="ms-2">{{ _('Esperando autorización de Pi...') }}</span>`;
        loginButton.disabled = true;

        // 3. Alcances que solicitamos al usuario
        const scopes = ['username', 'payments']; // 'payments' lo usaremos en el futuro para propinas

        // 4. Función que se ejecutará si el login con Pi es exitoso
        function onLoginSuccess(authResult) {
            feedbackDiv.innerHTML = `<div class="spinner-border spinner-border-sm" role="status"></div><span class="ms-2">{{ _('Verificando con el servidor...') }}</span>`;
            
            fetch("{{ url_for('pi_auth_complete') }}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(authResult)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    feedbackDiv.innerHTML = `<div class="alert alert-success p-2 mt-3">{{ _('¡Éxito! Redirigiendo...') }}</div>`;
                    // Redirigir al usuario a la página que indica el backend
                    window.location.href = data.redirect_url;
                } else {
                    feedbackDiv.innerHTML = `<div class="alert alert-danger p-2 mt-3">${data.error}</div>`;
                    loginButton.disabled = false;
                }
            })
            .catch(error => {
                console.error('Error en el fetch:', error);
                feedbackDiv.innerHTML = `<div class="alert alert-danger p-2 mt-3">{{ _('Error de conexión con el servidor.') }}</div>`;
                loginButton.disabled = false;
            });
        }

        // 5. Función que se ejecutará si el usuario cancela o hay un error
        function onLoginFailure(error) {
            console.error('Fallo en la autenticación de Pi:', error);
            feedbackDiv.innerHTML = `<div class="alert alert-warning p-2 mt-3">{{ _('La autorización con Pi fue cancelada o falló.') }}</div>`;
            loginButton.disabled = false;
        }

        // 6. Llamada principal al SDK para autenticar
        Pi.authenticate(scopes, onLoginSuccess, onLoginFailure);
    });
});
</script>
{% endblock %}



