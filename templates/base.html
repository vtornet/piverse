<!DOCTYPE html>
<html lang="{{ current_locale.language if current_locale else 'es' }}">
<head>
    <meta charset="UTF-8">
    <title>{% block title %}PiVerse{% endblock %}</title>
    <meta name="description" content="Bienvenido a PiVerse, la red social para la comunidad Pi Network. Conéctate, comparte y explora el universo Pi.">
    <meta name="keywords" content="PiVerse, Pi Network, red social, criptomonedas, comunidad Pi, pioneros Pi">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">

    {# --- INICIO: LÍNEA AÑADIDA --- #}
    <script src="https://sdk.pi-network.com/v2/pi-sdk.js"></script>
    {# --- FIN: LÍNEA AÑADIDA --- #}

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body {
            background-color: #f8f9fa; 
            padding-top: 56px; 
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .content-wrapper {
            flex: 1 0 auto; 
        }
        .navbar {
            background-color: #2c184b;
        }
        .navbar .navbar-brand img {
            max-height: 35px; 
            margin-right: 10px;
            border-radius: 4px;
        }
        .navbar .navbar-brand,
        .navbar .nav-link {
            color: #FFFFFF;
            font-weight: bold;
        }
        .navbar .nav-link:hover {
            color: #FFC107; 
        }
        .container {
            margin-top: 20px;
        }
        .card {
            margin-bottom: 20px;
            border: 1px solid #dee2e6;
        }
        .alert-container {
            position: fixed;
            top: 70px;
            right: 20px;
            z-index: 1050;
            width: auto;
            max-width: 400px;
        }
        .notification-badge {
            position: absolute;
            top: 0px;
            right: -5px;
            padding: 0.25em 0.5em;
            font-size: 0.7rem;
            line-height: 1;
        }
        
        .piverse-hero {
            background-color: #2c184b;
            color: white;
            padding: 3rem 1rem;
            margin-bottom: 2rem;
            border-radius: .3rem;
            text-align: center;
        }
        .piverse-hero .display-4 {
            font-size: 2.5rem;
            font-weight: 700;
            color: #FFA000; 
            margin-bottom: 0.5rem;
        }
         .piverse-hero .lead-piverse {
            font-size: 1.1rem;
            margin-bottom: 1.5rem;
        }
        .piverse-hero img.logo-hero {
            max-height: 300px;
            max-width: 90%;   
            width: auto;      
            height: auto;     
            margin-bottom: 1rem;
        }

        .mention-suggestions-list {
            position: absolute;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.15);
            z-index: 1000; 
            width: auto; 
            min-width: 200px; 
            max-height: 200px;
            overflow-y: auto;
            margin-top: 2px; 
        }
        .mention-suggestions-list ul { list-style: none; padding: 0; margin: 0; }
        .mention-suggestions-list li { padding: 8px 12px; cursor: pointer; display: flex; align-items: center; font-size: 0.9rem; }
        .mention-suggestions-list li:hover { background-color: #f5f5f5; }
        .mention-suggestions-list img { width: 24px; height: 24px; border-radius: 50%; margin-right: 8px; object-fit: cover; }
        .mention-suggestions-list .no-photo { width: 24px; height: 24px; border-radius: 50%; margin-right: 8px; background-color: #eee; display: inline-flex; align-items: center; justify-content: center; }
        .mention-suggestions-list .no-photo i { font-size: 12px; color: #777; }
        
        footer.footer-main { 
            padding: 1.5rem 0;
            margin-top: auto; 
            background-color: #f8f9fa; 
            color: #6c757d; 
            border-top: 1px solid #dee2e6; 
        }
        .index-main-content {
            background-color: #2c184b;
            color: #f0f0f0; 
            padding: 2rem 1rem; 
            border-radius: .3rem; 
            margin-top: 2rem; 
            margin-bottom: 2rem; 
        }
        .index-main-content .welcome-message,
        .index-main-content .welcome-message strong {
            color: #f8f9fa; 
        }
        .index-main-content .card .card-title,
        .index-main-content .card .card-text {
            color: #212529; 
        }

        .link-preview-card {
            display: flex;
            border: 1px solid #dee2e6;
            border-radius: .25rem;
            overflow: hidden;
            background-color: #fff;
            transition: background-color 0.2s ease-in-out;
            max-width: 100%; 
        }
        .link-preview-card:hover {
            background-color: #f8f9fa;
        }
        .link-preview-image {
            width: 120px;
            height: 120px;
            object-fit: cover;
            flex-shrink: 0; 
            border-right: 1px solid #dee2e6; 
        }
        .link-preview-info {
            padding: 0.75rem 1rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
            overflow: hidden;
            min-width: 0; 
        }
        .link-preview-title {
            font-size: 1rem;
            font-weight: 600;
            color: #212529;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis; 
        }
        .link-preview-description {
            font-size: 0.875rem;
            color: #6c757d;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2; 
            -webkit-box-orient: vertical;
        }
        .link-preview-url {
            font-size: 0.8rem;
            color: #495057;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
    </style>
    {% block head_extra %}{% endblock %}
</head>
<body>

<div id="mobile-debug-console" style="position: fixed; bottom: 0; left: 0; width: 100%; max-height: 30%; overflow-y: scroll; background: rgba(0,0,0,0.85); color: #00ff00; font-family: monospace; font-size: 10px; z-index: 9999; padding: 5px; box-sizing: border-box; pointer-events: none;"></div>
    <script>
        (function() {
            const consoleDiv = document.getElementById('mobile-debug-console');
            if (!consoleDiv) return;

            function logToScreen(args, type = 'log') {
                const p = document.createElement('p');
                let message = '';
                for (let i = 0; i < args.length; i++) {
                    try {
                        message += JSON.stringify(args[i]) + ' ';
                    } catch (e) {
                        message += '[Unserializable Object] ';
                    }
                }
                p.textContent = `[${type}] ${message}`;
                p.style.margin = '2px 5px';
                p.style.borderBottom = '1px solid #333';
                p.style.color = type === 'error' ? '#ff8a8a' : '#00ff00';
                consoleDiv.appendChild(p);
                consoleDiv.scrollTop = consoleDiv.scrollHeight;
            }

            const oldError = console.error;
            const oldLog = console.log;

            console.error = function(...args) {
                logToScreen(args, 'error');
                oldError.apply(console, args);
            };

            console.log = function(...args) {
                logToScreen(args, 'log');
                oldLog.apply(console, args);
            };

            window.onerror = function(message, source, lineno, colno, error) {
                const formattedMsg = `Uncaught: "${message}" at <span class="math-inline">\{source\.split\('/'\)\.pop\(\)\}\:</span>{lineno}`;
                logToScreen([formattedMsg], 'error');
                return false;
            };
        })();
    </script>
    <div class="content-wrapper">

<div class="content-wrapper">
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top px-3">
        <div class="container-fluid">
            <a class="navbar-brand d-flex align-items-center" href="{{ url_for('index') }}">
                <img src="{{ url_for('static', filename='images/piverse.png') }}" alt="{{ _('Logo de PiVerse') }}" style="max-height: 35px; margin-right: 10px; border-radius: 4px;">
                <span style="color: #FFFFFF; font-weight: bold;">PiVerse</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="{{ _('Alternar navegación') }}">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto mb-2 mb-lg-0 align-items-center">
                    {% if 'user_id' in session %}
                        <li class="nav-item">
                            <form class="d-flex pt-1" method="GET" action="{{ url_for('search') }}" role="search">
                                <input class="form-control form-control-sm me-1" type="search" name="q" placeholder="{{ _('Buscar...') }}" aria-label="{{ _('Buscar') }}" style="width: 150px; height: 31px;">
                                <button class="btn btn-sm btn-outline-light" type="submit" style="height: 31px; line-height: 1.2;"><i class="bi bi-search"></i></button>
                            </form>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link position-relative" href="{{ url_for('notificaciones') }}">
                                <i class="bi bi-bell-fill"></i> {{ _('Notificaciones') }}
                                <span class="badge rounded-pill bg-danger notification-badge {% if notificaciones_no_leidas_count == 0 %}d-none{% endif %}" id="notifications-count-badge">
                                    {{ notificaciones_no_leidas_count if notificaciones_no_leidas_count > 0 else '' }}
                                    <span class="visually-hidden">{{ _('notificaciones no leídas') }}</span>
                                </span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link position-relative" href="{{ url_for('mensajes') }}">
                                <i class="bi bi-chat-dots-fill"></i> {{ _('Mensajes') }}
                                <span class="badge rounded-pill bg-danger notification-badge {% if unread_messages_count == 0 %}d-none{% endif %}" id="messages-count-badge">
                                    {{ unread_messages_count if unread_messages_count > 0 else '' }}
                                    <span class="visually-hidden">{{ _('mensajes no leídos') }}</span>
                                </span>
                            </a>
                        </li>
                        <li class="nav-item"><a class="nav-link" href="{{ url_for('feed') }}"><i class="bi bi-house-door-fill"></i> {{ _('Inicio') }}</a></li>
                        <li class="nav-item"><a class="nav-link" href="{{ url_for('profile') }}"><i class="bi bi-person-circle"></i> {{ _('Mi Perfil') }}</a></li>
                        <li class="nav-item"><a class="nav-link" href="{{ url_for('contactos') }}"><i class="bi bi-people-fill"></i> {{ _('Mis Contactos') }}</a></li>
                        
                        {% if current_user_role in ['moderator', 'coordinator', 'admin'] %}
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="adminDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false" style="color: #ffc107;">
                                <i class="bi bi-shield-lock-fill"></i> {{ _('Admin') }}
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="adminDropdown">
                                <li><a class="dropdown-item" href="{{ url_for('admin_list_reports') }}">{{ _('Gestionar Reportes') }}</a></li>
                                <li><a class="dropdown-item" href="{{ url_for('admin_list_appeals') }}">{{ _('Gestionar Apelaciones') }}</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="{{ url_for('admin_users_list') }}">{{ _('Gestionar Usuarios') }}</a></li>
                                <li><a class="dropdown-item" href="{{ url_for('admin_list_posts') }}">{{ _('Gestionar Publicaciones') }}</a></li>
                                <li><a class="dropdown-item" href="{{ url_for('admin_list_comments') }}">{{ _('Gestionar Comentarios') }}</a></li>
                                {% if current_user_role in ['coordinator', 'admin'] %}
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="{{ url_for('admin_view_log') }}">{{ _('Log de Acciones') }}</a></li>
                                {% endif %}
                            </ul>
                        </li>
                        {% endif %}
                        
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('sections_list') }}">
                                <i class="bi bi-columns-gap"></i> {{ _('Secciones') }}
                            </a>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="languageDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="bi bi-translate"></i> 
                                {{ available_languages.get(current_locale, _('Idioma')) }}
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="languageDropdown">
                                {% for lang_code, lang_name in available_languages.items() %}
                                <li>
                                    <a class="dropdown-item {% if lang_code == current_locale %}active fw-bold{% endif %}" 
                                    href="{{ url_for('set_language', lang=lang_code, next=request.path) }}">
                                    {{ lang_name }}
                                    </a>
                                </li>
                                {% endfor %}
                            </ul>
                        </li>
                        <li class="nav-item me-2 ms-2">
                            {% if foto_usuario_actual %}
                                <a href="{{ url_for('profile') }}">
                                    <img src="{{ url_for('static', filename='uploads/' + foto_usuario_actual) }}" class="rounded-circle" style="width: 36px; height: 36px; object-fit: cover;" alt="{{ _('Foto de perfil de %(username)s', username=display_username_session) }}">
                                </a>
                            {% else %}
                                <a href="{{ url_for('profile') }}" class="text-decoration-none">
                                    <div class="rounded-circle bg-secondary d-flex justify-content-center align-items-center" style="width: 36px; height: 36px;" title="{{ _('Completar perfil') }}">
                                        <i class="bi bi-person-fill text-white"></i>
                                    </div>
                                </a>
                            {% endif %}
                        </li>
                        <li class="nav-item"><a class="nav-link" href="{{ url_for('logout') }}"><i class="bi bi-box-arrow-right"></i> {{ _('Cerrar sesión') }}</a></li>
                    {% else %}
                         <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="languageDropdownGuest" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="bi bi-translate"></i> 
                                {{ available_languages.get(current_locale, _('Idioma')) }}
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="languageDropdownGuest">
                                {% for lang_code, lang_name in available_languages.items() %}
                                <li>
                                    <a class="dropdown-item {% if lang_code == current_locale %}active fw-bold{% endif %}" 
                                       href="{{ url_for('set_language', lang=lang_code, next=request.path) }}">
                                        {{ lang_name }}
                                    </a>
                                </li>
                                {% endfor %}
                            </ul>
                        </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>
    <div class="container">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="alert-container">
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="{{ _('Cerrar') }}"></button>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}
        {% block content %}{% endblock %}
    </div>
</div> 

<footer class="footer-main text-center py-3">
    <div class="container">
        <small class="text-muted">&copy; {{ now().year if now else '2025' }} PiVerse - {{ _('Conectando Pioneros.') }}</small>
        <div class="mt-2">
            <a href="{{ url_for('privacy_policy') }}" class="text-decoration-none text-muted small mx-2">{{ _('Política de Privacidad') }}</a>
            <span class="text-muted">|</span>
            <a href="{{ url_for('terms_of_service') }}" class="text-decoration-none text-muted small mx-2">{{ _('Términos de Servicio') }}</a>
        </div>
    </div>
</footer>

{# --- MODAL DE COMPARTIR --- #}
<div class="modal fade" id="shareModal" tabindex="-1" aria-labelledby="shareModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="shareModalLabel">{{ _('Citar Publicación') }}</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ _('Cerrar') }}"></button>
            </div>
            <form id="share-modal-form" method="POST">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="quote_content_modal_textarea" class="form-label">{{ _('Añade un comentario (opcional):') }}</label>
                        <textarea class="form-control" id="quote_content_modal_textarea" name="quote_content" rows="3" placeholder="{{ _('¿Qué estás pensando sobre esto?') }}"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Cancelar') }}</button>
                    <button type="submit" class="btn btn-primary"><i class="bi bi-arrow-repeat"></i> {{ _('Compartir ahora') }}</button>
                </div>
            </form>
        </div>
    </div>
</div>

{# --- MODAL PARA REPORTES --- #}
<div class="modal fade" id="reportModal" tabindex="-1" aria-labelledby="reportModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="reportModalLabel">{{ _('Reportar Contenido') }}</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ _('Cerrar') }}"></button>
            </div>
            <form id="report-modal-form">
                <div class="modal-body">
                    <input type="hidden" id="report-content-type" name="content_type">
                    <input type="hidden" id="report-content-id" name="content_id">
                    
                    <p>{{ _('Gracias por ayudar a mantener segura la comunidad de PiVerse. Por favor, dinos por qué estás reportando este contenido.') }}</p>

                    <div class="mb-3">
                        <label for="report-reason" class="form-label">{{ _('Motivo del reporte') }}</label>
                        <select class="form-select" id="report-reason" name="reason" required>
                            <option value="" selected disabled>{{ _('Elige un motivo...') }}</option>
                            <option value="spam">{{ _('Spam o publicidad no deseada') }}</option>
                            <option value="hate_speech">{{ _('Lenguaje o símbolos que incitan al odio') }}</option>
                            <option value="harassment">{{ _('Acoso o bullying') }}</option>
                            <option value="misinformation">{{ _('Información falsa o engañosa') }}</option>
                            <option value="impersonation">{{ _('Suplantación de identidad') }}</option>
                            <option value="inappropriate_content">{{ _('Contenido explícito o inapropiado') }}</option>
                            <option value="other">{{ _('Otro motivo') }}</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="report-details" class="form-label">{{ _('Detalles adicionales (opcional)') }}</label>
                        <textarea class="form-control" id="report-details" name="details" rows="3" placeholder="{{ _('Proporciona más información si es necesario.') }}"></textarea>
                    </div>
                    <div id="report-feedback" class="mt-3"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Cancelar') }}</button>
                    <button type="submit" class="btn btn-danger">{{ _('Enviar Reporte') }}</button>
                </div>
            </form>
        </div>
    </div>
</div>


{% block scripts %}
{{ super() if super }} {# Añadimos 'if super' por si una plantilla hija no tiene super() #}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // Script de auto-cierre de alertas
    window.setTimeout(function() {
        var alerts = document.querySelectorAll('.alert-dismissible.show');
        alerts.forEach(function(alert) {
            new bootstrap.Alert(alert).close();
        });
    }, 7000);

    document.addEventListener('DOMContentLoaded', function() {
        // Lógica del modal de compartir
        const shareModalElement = document.getElementById('shareModal');
        if (shareModalElement) {
            const shareModalForm = document.getElementById('share-modal-form');
            shareModalElement.addEventListener('show.bs.modal', function(event) {
                const button = event.relatedTarget;
                const postId = button.getAttribute('data-post-id');
                let actionUrl = "{{ url_for('share_post', post_id=0) }}".replace('0', postId);
                if(shareModalForm) {
                    shareModalForm.setAttribute('action', actionUrl);
                }
            });
        }
        
        // Lógica para el modal de reporte
        const reportModalElement = document.getElementById('reportModal');
        if (reportModalElement) {
            const reportForm = document.getElementById('report-modal-form');
            const reportFeedbackDiv = document.getElementById('report-feedback');

            reportModalElement.addEventListener('show.bs.modal', function(event) {
                const button = event.relatedTarget;
                const contentType = button.getAttribute('data-content-type');
                const contentId = button.getAttribute('data-content-id');
                
                document.getElementById('report-content-type').value = contentType;
                document.getElementById('report-content-id').value = contentId;
                
                reportForm.reset();
                reportFeedbackDiv.innerHTML = '';
                reportForm.querySelector('button[type="submit"]').disabled = false;
            });

            reportForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const submitButton = reportForm.querySelector('button[type="submit"]');
                submitButton.disabled = true;
                reportFeedbackDiv.innerHTML = `<div class="spinner-border spinner-border-sm" role="status"><span class="visually-hidden">Loading...</span></div> {{ _('Enviando...') }}`;

                const formData = {
                    content_type: document.getElementById('report-content-type').value,
                    content_id: document.getElementById('report-content-id').value,
                    reason: document.getElementById('report-reason').value,
                    details: document.getElementById('report-details').value
                };

                fetch("{{ url_for('report_content') }}", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
                    body: JSON.stringify(formData)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        reportFeedbackDiv.innerHTML = `<div class="alert alert-success mt-3">${data.message}</div>`;
                        setTimeout(() => {
                            const modal = bootstrap.Modal.getInstance(reportModalElement);
                            modal.hide();
                        }, 2500);
                    } else {
                        reportFeedbackDiv.innerHTML = `<div class="alert alert-danger mt-3">${data.error}</div>`;
                        submitButton.disabled = false;
                    }
                })
                .catch(error => {
                    console.error("Error en el fetch del reporte:", error);
                    reportFeedbackDiv.innerHTML = `<div class="alert alert-danger mt-3">{{ _('Error de conexión. Inténtalo de nuevo.') }}</div>`;
                    submitButton.disabled = false;
                });
            });
        }

        // Lógica de Server-Sent Events para notificaciones
        const notificationsBadge = document.getElementById('notifications-count-badge');
        const messagesBadge = document.getElementById('messages-count-badge');
        if (notificationsBadge && messagesBadge) {
            const eventSource = new EventSource("{{ url_for('stream_notifications') }}");
            eventSource.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    if (data.unread_notifications !== undefined) {
                        notificationsBadge.textContent = data.unread_notifications > 0 ? data.unread_notifications : '';
                        notificationsBadge.classList.toggle('d-none', data.unread_notifications <= 0);
                    }
                    if (data.unread_messages !== undefined) {
                        messagesBadge.textContent = data.unread_messages > 0 ? data.unread_messages : '';
                        messagesBadge.classList.toggle('d-none', data.unread_messages <= 0);
                    }
                } catch (e) { console.error("Error al parsear datos SSE:", e); }
            };
            eventSource.onerror = function(err) { console.error("Error en EventSource:", err); };
        }
    });
</script>

{# === INICIO: SCRIPT GLOBAL PARA TODAS LAS INTERACCIONES COMUNES === #}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const body = document.body;

    // 1. LÓGICA PARA MOSTRAR/OCULTAR LA PALETA DE REACCIONES
    body.addEventListener('click', function(e) {
        const triggerBtn = e.target.closest('.reaction-trigger-btn');
        if (triggerBtn) {
            const palette = triggerBtn.nextElementSibling;
            if (!palette || !palette.classList.contains('reactions-palette')) return;
            
            const isVisible = palette.style.display === 'flex';
            document.querySelectorAll('.reactions-palette').forEach(p => {
                if (p !== palette) p.style.display = 'none';
            });
            palette.style.display = isVisible ? 'none' : 'flex';
            return;
        }
        if (!e.target.closest('.reactions-container')) {
            document.querySelectorAll('.reactions-palette').forEach(p => {
                p.style.display = 'none';
            });
        }
    });

    // 2. LÓGICA PARA ENVIAR REACCIONES CON AJAX
    body.addEventListener('submit', function (e) {
        if (!e.target.matches('.reaction-form')) {
            return;
        }
        e.preventDefault();

        const form = e.target;
        const url = form.action;
        const formData = new FormData(form);
        const triggerBtn = form.closest('.reactions-container').querySelector('.reaction-trigger-btn');
        
        fetch(url, {
            method: 'POST',
            body: formData,
            headers: {'X-Requested-With': 'XMLHttpRequest'}
        })
        .then(response => response.json())
        .then(data => {
            if (data.success && triggerBtn) {
                const reactionIcons = {'like': '👍', 'love': '❤️', 'haha': '😂', 'wow': '😮', 'sad': '😢', 'angry': '😠'};
                let content = '';
                if (data.action === 'removed') {
                    triggerBtn.classList.remove('btn-primary');
                    triggerBtn.classList.add('btn-outline-primary');
                    content = `<i class="bi bi-hand-thumbs-up"></i> {{ _('Reaccionar') }} (${data.new_total})`;
                } else {
                    triggerBtn.classList.remove('btn-outline-primary');
                    triggerBtn.classList.add('btn-primary');
                    const icon = reactionIcons[data.reaction_type] || '👍';
                    const reactionName = data.reaction_type.charAt(0).toUpperCase() + data.reaction_type.slice(1);
                    content = `${icon} ${_(reactionName)} (${data.new_total})`;
                }
                triggerBtn.innerHTML = content;
                const palette = form.closest('.reactions-palette');
                if (palette) palette.style.display = 'none';
            }
        }).catch(error => console.error('Fetch error:', error));
    });

    // 3. LÓGICA PARA RESPONDER A COMENTARIO
    body.addEventListener('click', function(e) {
        const replyBtn = e.target.closest('.reply-to-comment-btn');
        if (!replyBtn) return;
        
        e.preventDefault();
        const commentId = replyBtn.dataset.commentId;
        const usernameToReply = replyBtn.dataset.usernameToReply || 'Usuario';
        const slugToReply = replyBtn.dataset.slugToReply || '';
        const replyFormContainer = document.getElementById(`reply-form-container-${commentId}`);
        if (replyFormContainer) {
            const textarea = replyFormContainer.querySelector('textarea[name="content"]');
            const isHidden = replyFormContainer.style.display === 'none';
            document.querySelectorAll('.reply-form-container').forEach(c => {
                if (c.id !== replyFormContainer.id) c.style.display = 'none';
            });
            if (isHidden) {
                textarea.placeholder = `{{ _('Respondiendo a') }} @${usernameToReply}...`;
                textarea.value = `@${slugToReply} `;
                replyFormContainer.style.display = 'block';
                textarea.focus();
            } else {
                replyFormContainer.style.display = 'none';
            }
        }
    });

    // 4. LÓGICA PARA AUTOCOMPLETADO DE MENCIONES
    let currentActiveInput = null, currentSuggestionsBox = null, debounceTimer;
    function hideAllSuggestionBoxes() {
        document.querySelectorAll('.mention-suggestions-list').forEach(box => {
            if (box) {
                box.innerHTML = '';
                box.style.display = 'none';
            }
        });
    }
    body.addEventListener('input', function(e) {
        if (!e.target.matches('.mentionable-input')) return;
        currentActiveInput = e.target;
        const parentWrapper = currentActiveInput.closest('.input-group, .position-relative');
        currentSuggestionsBox = parentWrapper ? parentWrapper.querySelector('.mention-suggestions-list') : null;
        if (!currentSuggestionsBox) return;
        const text = currentActiveInput.value;
        const cursorPos = currentActiveInput.selectionStart;
        let atPos = text.lastIndexOf('@', cursorPos - 1);
        
        if (atPos !== -1 && (atPos === 0 || /\s/.test(text[atPos - 1]))) {
            const query = text.substring(atPos + 1, cursorPos);
            if (!/\s/.test(query)) {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => {
                    fetch(`/api/users/mention_search?term=${encodeURIComponent(query)}`)
                    .then(response => response.json())
                    .then(data => {
                        if (!currentSuggestionsBox) return;
                        currentSuggestionsBox.innerHTML = '';
                        if (data.length > 0) {
                            const ul = document.createElement('ul');
                            data.forEach(user => {
                                const li = document.createElement('li');
                                let photoHtml = user.photo ? `<img src="${user.photo}" alt="${user.username}">` : `<span class="no-photo"><i class="bi bi-person-fill"></i></span>`;
                                li.innerHTML = `${photoHtml}<span>${user.username} <small class="text-muted">(@${user.slug})</small></span>`;
                                li.addEventListener('mousedown', (evt) => {
                                    evt.preventDefault();
                                    const mentionText = `@${user.slug} `;
                                    const newText = text.substring(0, atPos) + mentionText + text.substring(cursorPos);
                                    currentActiveInput.value = newText;
                                    hideAllSuggestionBoxes();
                                    currentActiveInput.focus();
                                });
                                ul.appendChild(li);
                            });
                            currentSuggestionsBox.appendChild(ul);
                            currentSuggestionsBox.style.display = 'block';
                        } else {
                            hideAllSuggestionBoxes();
                        }
                    });
                }, 300);
            } else { hideAllSuggestionBoxes(); }
        } else { hideAllSuggestionBoxes(); }
    });
    body.addEventListener('click', (e) => {
        if (!e.target.matches('.mentionable-input')) {
            hideAllSuggestionBoxes();
        }
    });
});
<script>
document.addEventListener('DOMContentLoaded', function() {
    const authButton = document.getElementById('pi-auth-button');
    const feedbackDiv = document.getElementById('login-feedback');

    // Comprobamos si el botón de autenticación existe en la página actual
    if (authButton) {
        // 1. Inicializar el SDK de Pi
        const isProduction = window.location.hostname === 'www.piverse.app';
        Pi.init({ version: "2.0", sandbox: !isProduction });

        // 2. Añadir el evento de clic al botón
        authButton.addEventListener('click', function() {
            if (feedbackDiv) {
                feedbackDiv.innerHTML = `<div class="spinner-border spinner-border-sm" role="status"></div><span class="ms-2">{{ _('Esperando autorización de Pi...') }}</span>`;
            }
            authButton.disabled = true;

            const scopes = ['username'];

            // 3. Llamada al SDK
            Pi.authenticate(scopes)
                .then(function(authResult) {
                    if (feedbackDiv) {
                        feedbackDiv.innerHTML = `<div class="spinner-border spinner-border-sm" role="status"></div><span class="ms-2">{{ _('Verificando con el servidor...') }}</span>`;
                    }
                    return fetch("{{ url_for('pi_auth_complete') }}", {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(authResult)
                    });
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        if (feedbackDiv) {
                            feedbackDiv.innerHTML = `<div class="alert alert-success p-2 mt-3">{{ _('¡Éxito! Redirigiendo...') }}</div>`;
                        }
                        window.location.href = data.redirect_url;
                    } else {
                        if (feedbackDiv) {
                            feedbackDiv.innerHTML = `<div class="alert alert-danger p-2 mt-3">${data.error}</div>`;
                        }
                        authButton.disabled = false;
                    }
                })
                .catch(error => {
                    console.error('Fallo en el proceso de autenticación:', error);
                    let errorMessage;
                    if (error && error.type === 'Authentication_Failed') {
                        errorMessage = `{{ _('La autorización con Pi fue cancelada o falló.') }}`;
                    } else {
                        errorMessage = `{{ _('Error de conexión con el servidor.') }}`;
                    }
                    if (feedbackDiv) {
                        feedbackDiv.innerHTML = `<div class="alert alert-danger p-2 mt-3">${errorMessage}</div>`;
                    }
                    authButton.disabled = false;
                });
        });
    }
});
<script type="text/javascript">
document.addEventListener("DOMContentLoaded", function() {
  if (window.Pi) {
    window.Pi.authenticate(
      ['username'],
      function(auth) {
        fetch('/api/pi/auth/complete', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            accessToken: auth.accessToken
          }),
          credentials: 'same-origin'
        }).then(response => response.json())
          .then(data => {
            if (data.success) {
              window.location.reload();
            }
          });
      },
      function(error) {
        console.error('Pi authentication failed', error);
      }
    );
  }
});
</script>

{% endblock %}
</body>
</html>