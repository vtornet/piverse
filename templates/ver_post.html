{% extends "base.html" %}
{% from '_macros.html' import render_comment_thread %}

{% block title %}{{ _('Publicación de') }} @{{ post.username }}{% endblock %}

{% block head_extra %}
{{ super() }}
<style>
.comment-replies { margin-left: 40px; padding-left: 15px; border-left: 2px solid #eee; margin-top: 10px; }
.comment-container { margin-bottom: 15px; }
.reactions-container .reactions-palette { display: none; position: absolute; bottom: 100%; left: 0; margin-bottom: 5px; z-index: 10; white-space: nowrap; gap: 5px; }
.reaction-icon-btn { font-size: 1.5rem; padding: 0.2rem 0.4rem; text-decoration: none; border: none; background: none; cursor: pointer; }
.reaction-icon-btn:hover { transform: scale(1.2); transition: transform 0.1s ease-in-out; }
.post-section-link a { font-size: 0.85em; font-weight: 500; }
</style>
{% endblock %}


{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8 col-lg-7">
        <a href="{{ request.referrer or url_for('feed') }}" class="btn btn-outline-secondary btn-sm mb-3"><i class="bi bi-arrow-left"></i> {{ _('Volver') }}</a>
        
        <div class="card shadow-sm mb-4" id="post-{{ post.id }}">
            <div class="card-body">
                <div class="d-flex align-items-start mb-3">
                    <div class="flex-grow-1 d-flex align-items-center">
                        {% if post.photo %}
                            <img src="{{ url_for('static', filename='uploads/' + post.photo) }}" class="rounded-circle me-2" style="width: 40px; height: 40px; object-fit: cover;" alt="{{ _('Foto de %(username)s', username=post.username) }}">
                        {% else %}
                            <div class="rounded-circle bg-secondary d-flex justify-content-center align-items-center me-2" style="width: 40px; height: 40px;"><i class="bi bi-person-fill text-white fs-5"></i></div>
                        {% endif %}
                        <div>
                            <strong><a href="{{ url_for('ver_perfil', slug_perfil=post.slug) }}" class="text-decoration-none text-dark">@{{ post.username }}</a></strong><br>
                            <small class="text-muted">
                                {{ format_datetime(post.timestamp, 'medium') if post.timestamp else '' }}
                                {% if post.section_name and post.section_slug %}
                                    <span class="post-section-link">· {{ _('en') }} <a href="{{ url_for('view_section', slug_seccion=post.section_slug) }}" class="text-decoration-none">{{ _(post.section_name) }}</a></span>
                                {% endif %}
                            </small>
                        </div>
                    </div>
                    {% if session.user_id == post.autor_id_post or current_user_role in ['moderator', 'coordinator', 'admin'] %}
                    <div class="dropdown">
                        <button class="btn btn-sm btn-light" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-three-dots-vertical"></i>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            {% if session.user_id == post.autor_id_post or current_user_role in ['moderator', 'coordinator', 'admin'] %}
                            <li>
                                <form method="POST" action="{{ url_for('delete_post', post_id=post.id) }}" onsubmit="return confirm('{{ _('¿Estás seguro de que quieres eliminar esta publicación?') }}');">
                                    <button type="submit" class="dropdown-item text-danger"><i class="bi bi-trash me-2"></i>{{ _('Eliminar') }}</button>
                                </form>
                            </li>
                            {% endif %}
                            <li>
                                <a class="dropdown-item report-trigger-btn" href="#" data-bs-toggle="modal" data-bs-target="#reportModal" data-content-type="post" data-content-id="{{ post.id }}">
                                    <i class="bi bi-flag me-2"></i>{{ _('Reportar') }}
                                </a>
                            </li>
                        </ul>
                    </div>
                    {% endif %}
                </div>

                {% if post.content and post.content.strip() %}
                    <p class="card-text mt-2" style="white-space: pre-wrap;">{{ post.content | safe }}</p>
                {% endif %}

                {% if post.image_filename %}
                <div class="mb-2 text-center">
                    <img src="{{ url_for('static', filename='uploads/post_images/' + post.image_filename) }}" class="img-fluid rounded" alt="{{ _('Imagen de la publicación') }}" style="max-height: 450px; object-fit: contain; width: 100%;">
                </div>
                {% endif %}

                {% if post.preview_url %}
                <a href="{{ post.preview_url }}" target="_blank" rel="noopener noreferrer" class="text-decoration-none">
                    <div class="link-preview-card my-2">
                        {% if post.preview_image_url %}
                        <img src="{{ post.preview_image_url }}" class="link-preview-image" alt="{{ _('Imagen de previsualización') }}">
                        {% endif %}
                        <div class="link-preview-info">
                            <h6 class="link-preview-title mb-1">{{ post.preview_title or post.preview_url }}</h6>
                            <p class="link-preview-description text-muted small mb-1">{{ post.preview_description }}</p>
                            <small class="link-preview-url">{{ post.preview_url | replace('https://', '') | replace('http://', '') | truncate(40) }}</small>
                        </div>
                    </div>
                </a>
                {% endif %}

                <div class="mt-2 d-flex align-items-center">
                    <div class="reactions-container d-inline-block position-relative me-2">
                        <button class="btn btn-sm {% if post.user_reaction %}btn-primary{% else %}btn-outline-primary{% endif %} reaction-trigger-btn">
                            {% if post.user_reaction and post.user_reaction.reaction_type == 'love' %} ❤️
                            {% elif post.user_reaction and post.user_reaction.reaction_type == 'haha' %} 😂
                            {% elif post.user_reaction and post.user_reaction.reaction_type == 'wow' %} 😮
                            {% elif post.user_reaction and post.user_reaction.reaction_type == 'sad' %} 😢
                            {% elif post.user_reaction and post.user_reaction.reaction_type == 'angry' %} 😠
                            {% elif post.user_reaction and post.user_reaction.reaction_type == 'like' %} 👍
                            {% else %}<i class="bi bi-hand-thumbs-up"></i>{% endif %}
                            {% if post.user_reaction %}{{ _(post.user_reaction.reaction_type.capitalize()) }}{% else %}{{ _('Reaccionar') }}{% endif %}
                            ({{ post.total_reactions }})
                        </button>
                        <div class="reactions-palette bg-white border rounded shadow-sm p-1">
                            {% set reaction_types = {'like': '👍', 'love': '❤️', 'haha': '😂', 'wow': '😮', 'sad': '😢', 'angry': '😠'} %}
                            {% for type, icon in reaction_types.items() %}
                            <form method="POST" action="{{ url_for('react_to_post', post_id=post.id) }}" class="d-inline-block reaction-form">
                                <input type="hidden" name="reaction_type" value="{{ type }}">
                                <button type="submit" class="btn btn-link p-1 reaction-icon-btn" title="{{ _(type.capitalize()) }}">{{ icon }}</button>
                            </form>
                            {% endfor %}
                        </div>
                    </div>
                    <a href="#comment-form-{{ post.id }}-toplevel" class="btn btn-sm btn-outline-secondary">
                        <i class="bi bi-chat-dots"></i> {{ _('Comentarios') }} ({{ post.comments|length }})
                    </a>
                    <button type="button" class="btn btn-sm btn-outline-secondary share-trigger-btn ms-2"
                            data-bs-toggle="modal"
                            data-bs-target="#shareModal"
                            data-post-id="{{ post.id }}"
                            title="{{ _('Citar o compartir') }}">
                        <i class="bi bi-arrow-repeat"></i> {% if post.share_count > 0 %}{{ post.share_count }}{% endif %}
                    </button>
                </div>

                <hr>

                <div class="comments-section mt-3">
                    <h5 class="mb-3">{{ _('Comentarios') }}</h5>
                    {% if post.comments %}
                        {{ render_comment_thread(post.comments, post.id) }}
                    {% else %}
                        <p class="small text-muted">{{ _('No hay comentarios aún. ¡Sé el primero!') }}</p>
                    {% endif %}
                </div>
                
                <form method="post" action="{{ url_for('comment', post_id=post.id) }}" class="mt-3" id="comment-form-{{ post.id }}-toplevel">
                    <div class="input-group position-relative">
                        <input type="text" name="content" class="form-control form-control-sm mentionable-input" placeholder="{{ _('Escribe un comentario...') }}" required>
                        <div class="mention-suggestions-list" style="display: none;"></div>
                        <button type="submit" class="btn btn-sm btn-outline-secondary">{{ _('Comentar') }}</button>
                    </div>
                </form>

            </div>
        </div>
    </div>
</div>
{% endblock %}


{% block scripts %}
{{ super() }}
{# No se necesita ningún script local. Todo es heredado de base.html a través de super() #}
{% endblock %}