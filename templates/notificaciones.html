{% extends 'base.html' %}

{% block title %}{{ _('Mis Notificaciones') }} - PiVerse{% endblock %} 

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">{{ _('Notificaciones') }}</h2>
    
    {% if notificaciones %}
        <div class="list-group notification-list">
        {# --- BUCLE CORREGIDO --- #}
        {# Ahora iteramos sobre 'notif' que es un diccionario, y accedemos a sus propiedades con . #}
        {% for notif in notificaciones %}
            <div class="list-group-item list-group-item-action notification-item {% if not notif.leida %}list-group-item-warning fw-bold{% else %}list-group-item-light{% endif %}" 
                 data-notif-id="{{ notif.id }}"
                 style="cursor: pointer;">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <span class="d-block notification-message">{{ notif.mensaje|safe }}</span>
                        {# Ahora notif.timestamp es un objeto de fecha válido #}
                        <small class="text-muted">{{ format_datetime(notif.timestamp, 'medium') if notif.timestamp else '' }}</small>
                    </div>
                    <div class="ms-3">
                        {% if notif.tipo == 'solicitud_contacto' and not notif.leida %}
                            <form method="post" action="{{ url_for('aceptar_solicitud', id_solicitante=notif.referencia_id) }}" class="d-inline">
                                <button type="submit" class="btn btn-sm btn-success ms-2" title="{{ _('Aceptar') }}"><i class="bi bi-person-check-fill"></i></button>
                            </form>
                            <form method="post" action="{{ url_for('rechazar_solicitud', id_solicitante=notif.referencia_id) }}" class="d-inline">
                                <button type="submit" class="btn btn-sm btn-danger ms-1" title="{{ _('Rechazar') }}"><i class="bi bi-person-x-fill"></i></button>
                            </form>
                        {% endif %}
                    </div>
                </div>
            </div>
        {% endfor %}
        </div>
    {% else %}
        <div class="text-center p-5">
            <i class="bi bi-bell-slash" style="font-size: 3rem;"></i>
            <p class="lead mt-3">{{ _('No tienes notificaciones.') }}</p>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const notificationList = document.querySelector('.notification-list');

    if (notificationList) {
        notificationList.addEventListener('click', function(e) {
            const notifItem = e.target.closest('.notification-item');
            if (!notifItem) return;

            if (!notifItem.classList.contains('list-group-item-warning')) {
                if (e.target.tagName === 'A') { return; }
                e.preventDefault();
                return;
            }

            const notifId = notifItem.dataset.notifId;
            
            if (!e.target.closest('button')) {
                notifItem.classList.remove('list-group-item-warning', 'fw-bold');
                notifItem.classList.add('list-group-item-light');

                const badge = document.getElementById('notifications-count-badge');
                if (badge) {
                    let currentCount = parseInt(badge.textContent, 10);
                    if (!isNaN(currentCount) && currentCount > 0) {
                        badge.textContent = currentCount - 1;
                        if (badge.textContent == '0') {
                            badge.classList.add('d-none');
                        }
                    }
                }

                fetch(`/api/notificacion/marcar_leida/${notifId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                }).catch(error => console.error('Error al marcar la notificación como leída:', error));
            }
        });
    }
});
</script>
{% endblock %}